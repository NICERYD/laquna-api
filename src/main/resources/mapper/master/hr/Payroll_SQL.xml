<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.seedit.domain.mapper.seedit.PayrollDao">
	
	<select id="getFulltimePayrollList" parameterType="Map" resultType="kr.co.seedit.domain.hr.dto.PayrollDto">
		SELECT -- he.hire_date -- 입사년일
			CONCAT(hire_date, CASE WHEN CONCAT(SUBSTRING(retire_date,1,4),SUBSTRING(retire_date,6,2)) = hdcs.yyyymm THEN CONCAT(' ',retire_date) ELSE '' END) as hire_date
			, CASE
				WHEN CONCAT(SUBSTRING(hire_date,1,4),SUBSTRING(hire_date,6,2)) = hdcs.yyyymm THEN 'RETIRE'
				WHEN CONCAT(SUBSTRING(retire_date,1,4),SUBSTRING(retire_date,6,2)) = hdcs.yyyymm THEN 'NEW'
				ELSE ''
				END as hire_div
			, fcd02.defined_name  -- 직급
			, he.department_id -- 부서 아이디
			, '' AS department_name -- 시급제 부서(ex.머시닝)
			, he.korean_name  -- 이름
			, he.employee_type -- 100 연봉제
			, hsb.basic_salary + hsb.overtime_allowance + hsb.night_allowance AS month_salary -- 월급여
			, (hsb.basic_salary + hsb.overtime_allowance + hsb.night_allowance) * 13 AS year_salary -- 년봉
			, 0 AS day_pay -- 일급
			, CASE hdmkt.total_time
				WHEN 0 THEN NULL
				ELSE hsb.basic_salary / hdmkt.total_time
				END
				 AS hourly_pay -- 시급
			, hdmkt.total_time -- 총근무시간
			, hsb.basic_salary -- 기본금
			, 0 AS annual_leave_amt -- 연차수당
			, hdmkt.overtime_1 -- 연장1 시간
			, hdcs.attribute02 AS overtime01_amt -- 연장1 수당
			, hdmkt.overtime_2 -- 연장2 시간 
			, hdcs.attribute03 AS overtime02_amt -- 연장2 수당
			, hdmkt.night_shift_1 -- 야간1 시간
			, hdcs.attribute04 AS night01_allowance -- 야간1 수당
			, 0 as daytime_hours -- 주간조야간
			, 0 as nighttime_hours -- 야간조야간
			, hdmkt.night_shift_2 -- 야간2 시간
			, hdcs.attribute05 AS night02_allowance -- 야간2 수당
			, hdmkt.holiday_saturday_1  -- 휴일(토요일) 근무
			, hdcs.attribute06 * (hdmkt.holiday_saturday_1/(hdmkt.holiday_saturday_1+hdmkt.holiday_sunday_1)) AS holiday01_saturday_amt -- 휴일(토요일) 수당
			, hdmkt.holiday_sunday_1 -- 휴일(일요일) 근무
			, hdcs.attribute06 * (hdmkt.holiday_sunday_1/(hdmkt.holiday_saturday_1+hdmkt.holiday_sunday_1)) AS holiday01_sunday_amt -- 휴일(일요일) 수당
			, hdmkt.holiday_2 -- 휴일2 근무
			, hdcs.attribute07 AS holiday02_amt -- 휴일2 수당 
			, hdmkt.annual_leave_used_day -- 연차사용일자
			, hdmkt.annual_leave_used -- 연차사용횟수
			, hdmkt.transportation -- 교통비제공횟수
			, hdcs.attribute15 -- 교통비
			, hdmkt.meal -- 식대제공횟수
			, hdcs.attribute16  -- 식대금액
			-- , hdmkt.half_day -- 반차사용일자
			, hdmkt.half_time -- 반차사용시간
			, hdmkt.early_leave_day -- 조퇴일자
			, hdmkt.early_leave_time -- 조퇴횟수 
			, hdcs.attribute13 AS early_leave_amt -- 조퇴차감금액
			, hdmkt.late_day -- 지각일자
			, hdmkt.late_time  -- 지각시간
			, hdcs.attribute14 AS late_amt -- 지각차감금액
			, hdmkt.outer_day -- 외출일자
			, hdmkt.outer_time -- 외출시간
			, hdcs.attribute17 -- 외출차감금액
			, IFNULL(hsb.basic_salary,0) -- 기본금
				+ IFNULL(hdcs.attribute02,0) -- AS overtime01_amt -- 연장1 수당
				+ IFNULL(hdcs.attribute03,0) -- AS overtime02_amt -- 연장2 수당
				+ IFNULL(hdcs.attribute04,0) -- AS night01_allowance -- 야간1 수당
				+ IFNULL(hdcs.attribute05,0) -- AS night02_allowance -- 야간2 수당
				+ CASE WHEN IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0) = 0 THEN 0
					ELSE IFNULL(hdcs.attribute06,0) * (IFNULL(hdmkt.holiday_saturday_1,0)/(IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0))) -- AS holiday01_saturday_amt -- 휴일(토요일) 수당
					END
				+ CASE WHEN IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0) = 0 THEN 0
					ELSE IFNULL(hdcs.attribute06,0) * (IFNULL(hdmkt.holiday_sunday_1  ,0)/(IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0))) -- AS holiday01_sunday_amt -- 휴일(일요일) 수당
					END
				+ IFNULL(hdcs.attribute07,0) -- AS holiday02_amt -- 휴일2 수당 
				as total_salary -- 합계
		FROM  hr_dh_calc_salary hdcs
		INNER JOIN hr_dh_monthly_keun_tae hdmkt
		ON hdcs.company_id = hdmkt.company_id 
		AND hdcs.employee_id = hdmkt.employee_id 
		AND hdcs.yyyymm = hdmkt.yyyymm 
		INNER JOIN hr_employee he
		ON hdcs.company_id = he.company_id 
		AND hdcs.employee_id = he.employee_id 
		AND hdcs.yyyymm = he.attribute1 
		INNER JOIN (SELECT employee_id
				, company_id
				, GROUP_CONCAT( case basic_code WHEN 100 THEN  basic_amount end) AS basic_salary 
				, GROUP_CONCAT( case basic_code WHEN 101 THEN  basic_amount end) AS hourly_pay
				, GROUP_CONCAT( case basic_code WHEN 102 THEN  basic_amount end) AS overtime_allowance
				, GROUP_CONCAT( case basic_code WHEN 103 THEN  basic_amount end) AS night_allowance
				, GROUP_CONCAT( case basic_code WHEN 104 THEN  basic_amount end) AS holiday_allowance
				, GROUP_CONCAT( case basic_code WHEN 105 THEN  basic_amount end) AS prepayment 
				FROM hr_salary_basic
				GROUP BY employee_id, company_id) hsb
		ON hdcs.company_id = hsb.company_id 
		AND hdcs.employee_id  = hsb.employee_id 
		-- 직급
		INNER JOIN fnd_code fc02
		ON fc02.company_id  = he.company_id 
		AND fc02.code_field = 'HR_A0003'
		INNER JOIN fnd_code_detail fcd02
		ON fcd02.company_id  = he.company_id 
		AND fcd02.code_id = fc02.code_id 
		AND fcd02.defined_cd = he.position_code 
		WHERE hdcs.company_id  = #{companyId}
		AND   he.employee_type = '100'
		AND   hdcs.yyyymm = #{yyyymm}
	</select>
	
	<select id="getParttimePayrollList" parameterType="Map" resultType="kr.co.seedit.domain.hr.dto.PayrollDto">
		SELECT -- he.hire_date -- 입사년일
			CONCAT(hire_date, CASE WHEN CONCAT(SUBSTRING(retire_date,1,4),SUBSTRING(retire_date,6,2)) = hdcs.yyyymm THEN CONCAT(' ',retire_date) ELSE '' END) as hire_date
			, CASE
				WHEN CONCAT(SUBSTRING(hire_date,1,4),SUBSTRING(hire_date,6,2)) = hdcs.yyyymm THEN 'RETIRE'
				WHEN CONCAT(SUBSTRING(retire_date,1,4),SUBSTRING(retire_date,6,2)) = hdcs.yyyymm THEN 'NEW'
				ELSE ''
				END as hire_div
			, fcd02.defined_name  -- 직급
			, he.department_id -- 부서 아이디
			, '' AS department_name -- 시급제 부서(ex.머시닝)
			, he.korean_name  -- 이름
			, he.employee_type -- 200 시급제
			, 0 AS month_salary -- 월급여
			, 0 AS year_salary -- 년봉
			, hsb.hourly_pay * 8 AS day_pay -- 일급
			, hsb.hourly_pay AS hourly_pay -- 시급
			, hdmkt.total_time -- 총근무시간
			, hdmkt.total_time * hsb.hourly_pay AS basic_salary -- 기본금
			, hdcs.attribute01 AS annual_leave_amt -- 연차수당
			, hdmkt.overtime_1 -- 연장1 시간
			, hdcs.attribute02 AS overtime01_amt -- 연장1 수당
			, 0 AS overtime_2 -- 연장2 시간 
			, 0 AS overtime02_amt -- 연장2 수당
			, hdmkt.night_shift_1 -- 야간1 시간
			, hdcs.attribute04 AS night01_allowance -- 야간1 수당
			, hdmkt.daytime_hours -- 주간조야간
			, hdmkt.daytime_hours * hsb.hourly_pay as daytime_hours_amt -- 주간조야간금액
			, hdmkt.nighttime_hours -- 야간조야간
			, hdmkt.nighttime_hours * hsb.hourly_pay as nighttime_hours_amt -- 야간조야간금액
			, 0 AS night_shift_2 -- 야간2 시간
			, 0 AS night02_allowance -- 야간2 수당
			, hdmkt.holiday_saturday_1  -- 휴일(토요일) 근무
			, hdcs.attribute06 * (hdmkt.holiday_saturday_1/(hdmkt.holiday_saturday_1+hdmkt.holiday_sunday_1)) AS holiday01_saturday_amt -- 휴일(토요일) 수당
			, hdmkt.holiday_sunday_1 -- 휴일(일요일) 근무
			, hdcs.attribute06 * (hdmkt.holiday_sunday_1/(hdmkt.holiday_saturday_1+hdmkt.holiday_sunday_1)) AS holiday01_sunday_amt -- 휴일(일요일) 수당
			, hdmkt.holiday_2 -- 휴일2 근무
			, hdcs.attribute07 AS holiday02_amt -- 휴일2 수당 
			, hdmkt.annual_leave_used_day -- 연차사용일자
			, hdmkt.annual_leave_used -- 연차사용횟수
			, hdmkt.transportation -- 교통비제공횟수
			, hdcs.attribute15 -- 교통비
			, hdmkt.meal -- 식대제공횟수
			, hdcs.attribute16  -- 식대금액
			, hdmkt.half_day -- 반차사용일자
			, hdmkt.half_time -- 반차사용시간
			, hdmkt.half_time * hsb.hourly_pay * -1 as half_time_amt -- 반차사용금액
			, hdmkt.early_leave_day -- 조퇴일자
			, hdmkt.early_leave_time -- 조퇴횟수 
			, hdcs.attribute13 * -1 AS early_leave_amt -- 조퇴차감금액
			, hdmkt.late_day -- 지각일자
			, hdmkt.late_time  -- 지각시간
			, hdcs.attribute14 * -1 AS late_amt -- 지각차감금액
			, hdmkt.outer_day -- 외출일자
			, hdmkt.outer_time -- 외출시간
			, hdcs.attribute17 -- 외출차감금액
			, IFNULL(hsb.basic_salary,0) -- 기본금
				+ IFNULL(hdcs.attribute02,0) -- AS overtime01_amt -- 연장1 수당
				+ IFNULL(hdcs.attribute04,0) -- AS night01_allowance -- 야간1 수당
				+ IFNULL(hdcs.attribute05,0) -- AS night02_allowance -- 야간2 수당
				+ CASE WHEN IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0) = 0 THEN 0
					ELSE IFNULL(hdcs.attribute06,0) * (IFNULL(hdmkt.holiday_saturday_1,0)/(IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0))) -- AS holiday01_saturday_amt -- 휴일(토요일) 수당
					END
				+ CASE WHEN IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0) = 0 THEN 0
					ELSE IFNULL(hdcs.attribute06,0) * (IFNULL(hdmkt.holiday_sunday_1  ,0)/(IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0))) -- AS holiday01_sunday_amt -- 휴일(일요일) 수당
					END
				- IFNULL(hdmkt.half_time,0) * IFNULL(hsb.hourly_pay,0) -- * -1 as half_time_amt -- 반차사용금액
				- IFNULL(hdcs.attribute13,0) -- * -1 AS early_leave_amt -- 조퇴차감금액
				- IFNULL(hdcs.attribute14,0) -- * -1 AS late_amt -- 지각차감금액
				as totalSalary -- 합계
			, IFNULL(hsb.basic_salary,0) -- 기본금
				+ IFNULL(hdcs.attribute02,0) -- AS overtime01_amt -- 연장1 수당
				+ IFNULL(hdcs.attribute03,0) -- AS overtime02_amt -- 연장2 수당
				+ IFNULL(hdcs.attribute04,0) -- AS night01_allowance -- 야간1 수당
				+ IFNULL(hdcs.attribute05,0) -- AS night02_allowance -- 야간2 수당
				+ CASE WHEN IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0) = 0 THEN 0
					ELSE IFNULL(hdcs.attribute06,0) * (IFNULL(hdmkt.holiday_saturday_1,0)/(IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0))) -- AS holiday01_saturday_amt -- 휴일(토요일) 수당
					END
				+ CASE WHEN IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0) = 0 THEN 0
					ELSE IFNULL(hdcs.attribute06,0) * (IFNULL(hdmkt.holiday_sunday_1  ,0)/(IFNULL(hdmkt.holiday_saturday_1,0)+IFNULL(hdmkt.holiday_sunday_1,0))) -- AS holiday01_sunday_amt -- 휴일(일요일) 수당
					END
				+ IFNULL(hdcs.attribute07,0) -- AS holiday02_amt -- 휴일2 수당 
				as total_salary -- 합계
		FROM  hr_dh_calc_salary hdcs
		INNER JOIN hr_dh_monthly_keun_tae hdmkt
		ON hdcs.company_id = hdmkt.company_id 
		AND hdcs.employee_id = hdmkt.employee_id 
		AND hdcs.yyyymm = hdmkt.yyyymm 
		INNER JOIN hr_employee he
		ON hdcs.company_id = he.company_id 
		AND hdcs.employee_id = he.employee_id 
		AND hdcs.yyyymm = he.attribute1 
		INNER JOIN (SELECT employee_id
				, company_id
				, GROUP_CONCAT( case basic_code WHEN 100 THEN  basic_amount end) AS basic_salary 
				, GROUP_CONCAT( case basic_code WHEN 101 THEN  basic_amount end) AS hourly_pay
				, GROUP_CONCAT( case basic_code WHEN 102 THEN  basic_amount end) AS overtime_allowance
				, GROUP_CONCAT( case basic_code WHEN 103 THEN  basic_amount end) AS night_allowance
				, GROUP_CONCAT( case basic_code WHEN 104 THEN  basic_amount end) AS holiday_allowance
				, GROUP_CONCAT( case basic_code WHEN 105 THEN  basic_amount end) AS prepayment 
			FROM hr_salary_basic
			GROUP BY employee_id, company_id) hsb 
		ON hdcs.company_id = hsb.company_id 
		AND hdcs.employee_id  = hsb.employee_id 
		-- 직급
		INNER JOIN fnd_code fc02
		ON fc02.company_id  = he.company_id 
		AND fc02.code_field = 'HR_A0003'
		INNER JOIN fnd_code_detail fcd02
		ON fcd02.company_id  = he.company_id 
		AND fcd02.code_id = fc02.code_id 
		AND fcd02.defined_cd = he.position_code
		WHERE hdcs.company_id  = #{companyId}
		AND   he.employee_type = '200'
		AND   hdcs.yyyymm = #{yyyymm}
	</select>
	
</mapper>